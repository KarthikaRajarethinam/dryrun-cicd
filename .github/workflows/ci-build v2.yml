name: Build & Deploy Microservices v2

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/**"
      - "cloud-dry-run/docker-compose.yml"

jobs:
  build-and-deploy:
    name: Build & Deploy Affected Microservices
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    environment:
      name: production
      url: https://console.cloud.google.com/artifacts

    permissions:
      contents: read
      id-token: write  # Needed for Workload Identity Federation
      pull-requests: write  # Needed to comment on PR

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Docker Compose v2
        run: |
          mkdir -p ~/.docker/cli-plugins/
          curl -SL https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
          chmod +x ~/.docker/cli-plugins/docker-compose
          docker compose version


      - name: Authenticate to Google Cloud via Workload Identity Federation
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: 'projects/30467746746/locations/global/workloadIdentityPools/github-cicd/providers/github'
          service_account: 'github-wif@das-terraform-dry-run.iam.gserviceaccount.com'
          
      - name: Configure Docker to use Artifact Registry
        run: |
          gcloud auth configure-docker australia-southeast1-docker.pkg.dev --quiet

      - name: Ensure Artifact Registry repo exists or create it
        run: |
          set -e
          REPO_NAME="das-docker-repo"
          LOCATION="australia-southeast1"
          PROJECT_ID="das-terraform-dry-run"

          echo "Checking if Artifact Registry repo '$REPO_NAME' exists in '$LOCATION'..."

          if gcloud artifacts repositories describe "$REPO_NAME" --location="$LOCATION" --project="$PROJECT_ID" >/dev/null 2>&1; then
            echo "Repository '$REPO_NAME' already exists."
          else
            echo "Repository '$REPO_NAME' not found. Creating it now..."
            gcloud artifacts repositories create "$REPO_NAME" \
              --repository-format=docker \
              --location="$LOCATION" \
              --description="Docker repo for microservices CI/CD" \
              --project="$PROJECT_ID"
            echo "Repository '$REPO_NAME' created successfully."
          fi

      - name: Detect changed microservices
        id: changes
        run: |
          echo "Detecting changed microservices..."
          changed=""

          # Compare with base ref (defaults to previous commit on main)
          base_ref=$(git merge-base origin/main HEAD)
          changed_files=$(git diff --name-only "$base_ref" HEAD)    

          if echo "$changed_files" | grep -q "^backend/microservice-a/"; then
            changed="$changed microservice-a"
          fi
          if echo "$changed_files" | grep -q "^backend/microservice-b/"; then
            changed="$changed microservice-b"
          fi
          if echo "$changed_files" | grep -q "^frontend/"; then
            changed="$changed frontend"
          fi

          echo "Changed services: $changed"
          echo "services=$changed" >> "$GITHUB_OUTPUT"

      - name: Build and push changed services
        if: steps.changes.outputs.services != ''
        run: |
          for svc in ${{ steps.changes.outputs.services }}; do
            echo "::group::Building $svc"
            docker compose -f cloud-dry-run/docker-compose.yml build "$svc"
            echo "::endgroup::"

            echo "::group::Pushing $svc"
            docker compose -f cloud-dry-run/docker-compose.yml push "$svc"
            echo "::endgroup::"
          done

      - name: List recent images from Artifact Registry
        run: |
          for svc in microservice-a microservice-b frontend; do
            echo "::group::Images for $svc"
            gcloud artifacts docker images list australia-southeast1-docker.pkg.dev/das-terraform-dry-run/das-docker-repo/$svc \
              --limit=5 \
              --format="table[box](DIGEST, TAGS, IMAGE_SIZE_BYTES, UPLOAD_TIME)"
            echo "::endgroup::"
          done

      - name: Comment on PR with services built
        if: github.event_name == 'pull_request' && steps.changes.outputs.services != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ðŸš€ **Microservices Build Report**
            The following services were detected as changed and have been built/pushed to Google Artifact Registry:

            ```
            ${{ steps.changes.outputs.services }}
            ```

            âœ… View full logs: [GitHub Action Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Workflow completed
        run: echo "CI/CD workflow completed successfully and tested ."

